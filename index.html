<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>‡∏™‡πà‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å ‡∏£‡∏õ‡∏†.</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{--green:#06C755;--navy:#101B4D}
    body{background:#f0f2f5;font-family:'Sarabun',sans-serif;padding-bottom:80px}
    #liff-loading{position:fixed;inset:0;background:rgba(255,255,255,.97);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
    .spinner{width:48px;height:48px;border:5px solid #e5e7eb;border-top-color:var(--navy);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #error-screen{display:none;position:fixed;inset:0;background:#fff;z-index:9998;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center}
    .err-box{background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:14px;font-size:.82rem;color:#991b1b;max-width:400px;word-break:break-all;margin-top:12px;text-align:left}
    #blocked-screen{display:none;position:fixed;inset:0;background:#fff;z-index:9998;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center}
    .liff-header{background:linear-gradient(135deg,var(--navy),#1e3a8a);color:#fff;padding:14px 16px;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.25)}
    .user-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);border-radius:20px;padding:3px 10px;font-size:.82rem;margin-top:5px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0}
    .tab-bar{background:#fff;border-bottom:2px solid #e5e7eb;display:flex}
    .tab-btn{flex:1;border:none;background:transparent;padding:11px 8px;font-size:.88rem;color:#6b7280;font-weight:600;border-bottom:3px solid transparent;cursor:pointer}
    .tab-btn.active{color:var(--navy);border-bottom-color:var(--navy)}
    .tab-pane{display:none}
    .tab-pane.active{display:block}
    .section-card{background:#fff;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.08);margin:10px;overflow:hidden}
    .card-head{background:#f8f9fa;padding:9px 14px;font-weight:700;font-size:.88rem;color:var(--navy);border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:8px}
    .form-wrap{padding:12px}
    .form-label{font-size:.83rem;font-weight:600;color:#374151;margin-bottom:3px}
    .form-control,.form-select{border-radius:8px;font-size:.88rem;border:1.5px solid #d1d5db}
    .form-control[readonly]{background:#f3f4f6;color:#6b7280}
    .emp-card{background:#fff;border:1.5px solid #e5e7eb;border-radius:10px;margin:8px 10px;overflow:hidden}
    .emp-head{background:#f8f9fa;padding:7px 12px;display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:.83rem;color:var(--navy)}
    .emp-body{padding:10px 12px}
    .btn-remove-emp{border:none;background:transparent;color:#ef4444;font-size:.8rem;cursor:pointer;padding:2px 6px;border-radius:4px}
    .btn-add-emp{display:flex;align-items:center;justify-content:center;gap:6px;margin:6px 10px;padding:9px;border:2px dashed #3b82f6;border-radius:10px;color:#3b82f6;background:transparent;font-weight:600;font-size:.88rem;width:calc(100% - 20px);cursor:pointer}
    .btn-submit{position:fixed;bottom:0;left:0;right:0;border-radius:0;padding:15px;font-size:.95rem;font-weight:700;background:linear-gradient(135deg,var(--green),#00b900);border:none;color:#fff;box-shadow:0 -2px 10px rgba(0,0,0,.15);z-index:99}
    .badge-pending{background:#fef3c7;color:#92400e}
    .badge-transferred{background:#d1fae5;color:#065f46}
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô */
    .site-emp-item { display:flex; justify-content:space-between; align-items:center; padding:10px 14px; border-bottom:1px solid #f3f4f6; font-size:.88rem; }
    .site-emp-item:last-child { border-bottom:none; }
    .btn-quick-add { background:#ebf5ff; color:#3b82f6; border:1px solid #bfdbfe; border-radius:6px; padding:4px 12px; font-size:.78rem; font-weight:600; cursor:pointer; transition:0.2s; }
    .btn-quick-add:hover { background:#dbeafe; }
  </style>
</head>
<body>

<div id="liff-loading">
  <div class="spinner"></div>
  <p id="loading-msg" style="margin-top:14px;color:var(--navy);font-weight:600;font-size:1rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...</p>
  <p id="loading-sub" style="margin-top:4px;color:#6b7280;font-size:.8rem;"></p>
</div>

<div id="error-screen">
  <div style="font-size:3rem;color:#ef4444;">‚ö†Ô∏è</div>
  <h5 style="color:#1f2937;margin-top:10px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h5>
  <div class="err-box" id="error-detail"></div>
  <button class="btn btn-sm btn-outline-secondary mt-3" onclick="location.reload()">
    <i class="fas fa-rotate me-1"></i> ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
  </button>
</div>

<div id="blocked-screen">
  <div style="font-size:3.5rem;margin-bottom:14px;">üö´</div>
  <h5 style="color:#1f2937;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
  <p style="color:#6b7280;font-size:.9rem;">LINE ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
  <div style="background:#fef9c3;border:1px solid #fde68a;border-radius:8px;padding:10px 14px;font-size:.82rem;color:#78350f;margin-top:10px;max-width:380px;">
    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á LineUserID ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ Admin ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Users Sheet ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F
  </div>
  <div id="blocked-uid" style="margin-top:10px;font-size:.75rem;color:#374151;word-break:break-all;background:#f3f4f6;border-radius:6px;padding:8px 12px;width:90%;max-width:380px;"></div>
  <button class="btn btn-outline-secondary btn-sm mt-3" onclick="copyUid()">
    <i class="fas fa-copy me-1"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å LineUserID
  </button>
</div>

<div id="main-app" style="display:none;">
  <div class="liff-header">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <div style="font-size:.95rem;font-weight:700;"><i class="fas fa-shield-alt me-2"></i>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏£‡∏õ‡∏†.</div>
        <div class="user-badge"><span class="dot"></span><span id="user-name-display">...</span></div>
      </div>
      <div style="font-size:1.5rem;opacity:.5;"><i class="fab fa-line"></i></div>
    </div>
  </div>

  <div class="tab-bar">
    <button class="tab-btn active" id="btn-tab-send" onclick="switchTab('send')">
      <i class="fas fa-paper-plane me-1"></i> ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    </button>
    <button class="tab-btn" id="btn-tab-history" onclick="switchTab('history');loadMyRequests();">
      <i class="fas fa-history me-1"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
    </button>
  </div>

  <div id="tab-send" class="tab-pane active">
    
    <div class="section-card">
      <div class="card-head"><i class="fas fa-user-circle" style="color:var(--green)"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</div>
      <div class="form-wrap">
        <div class="mb-3">
          <label class="form-label">‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (LINE)</label>
          <input type="text" id="headName" class="form-control" readonly>
        </div>
        <div>
          <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô <span class="text-danger">*</span></label>
          <select class="form-select" id="siteSelect" onchange="handleSiteChange()">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>
          </select>
          <div id="site-empty-hint" class="text-warning mt-1" style="font-size:.78rem;display:none;">
            <i class="fas fa-exclamation-triangle me-1"></i>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin
          </div>
        </div>
      </div>
    </div>

    <div class="section-card" id="site-emp-card" style="display:none;">
      <div class="card-head" style="cursor:pointer;" onclick="toggleSiteEmpList()">
        <span><i class="fas fa-list-ul" style="color:#f59e0b"></i> ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</span>
        <i class="fas fa-chevron-down ms-auto" id="site-emp-arrow"></i>
      </div>
      <div class="form-wrap" id="site-emp-list-container" style="display:none; padding: 0;">
        <div id="site-emp-list">
          </div>
      </div>
    </div>

    <div class="section-card" style="padding-bottom:4px;">
      <div class="card-head"><i class="fas fa-users" style="color:#3b82f6"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
      <div id="empList" class="pt-1"></div>
      <button class="btn-add-emp" onclick="addEmpRow()"><i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
    </div>

    <div class="section-card">
      <div class="form-wrap d-flex justify-content-between">
        <span style="font-size:.85rem;color:#6b7280;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <b id="count-emp">0</b> ‡∏Ñ‡∏ô</span>
        <span style="font-size:.85rem;color:#6b7280;">‡∏£‡∏ß‡∏°: <b id="sum-amount" class="text-success">0.00</b> ‡∏ö‡∏≤‡∏ó</span>
      </div>
    </div>
  </div>

  <div id="tab-history" class="tab-pane">
    <div style="padding:10px;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <b style="color:var(--navy);">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</b>
        <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="loadMyRequests()">
          <i class="fas fa-rotate me-1"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
        </button>
      </div>
      <div id="history-list">
        <div class="text-center text-muted py-5">
          <i class="fas fa-inbox fa-2x mb-2 d-block" style="opacity:.3"></i>‡∏Å‡∏î "‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î
        </div>
      </div>
    </div>
  </div>
</div>

<button class="btn-submit" id="btn-submit-main" onclick="submitRequests()" style="display:none;">
  <i class="fas fa-paper-plane me-2"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å
</button>

<script>
// =====================================================
// ‚òÖ‚òÖ‚òÖ ‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡∏™‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚òÖ‚òÖ‚òÖ
const LIFF_ID    = '2009071711-LrtWbQgz';
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxa3MfOzPz5hkSNLBGdOr_UUr0ZJu3UOuv98_yHu7UVlE7D9V2KvYe9TwgKqHJ9m4NIgw/exec';
// =====================================================

let currentUser = null;
let lineUserId  = null;
let empRowCount = 0;

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ
function setMsg(main, sub) {
  document.getElementById('loading-msg').textContent = main || '';
  document.getElementById('loading-sub').textContent = sub  || '';
}
function hideLoading(){ document.getElementById('liff-loading').style.display = 'none'; }
function showError(msg){
  hideLoading();
  document.getElementById('error-detail').innerHTML = msg;
  document.getElementById('error-screen').style.display = 'flex';
}
function showBlocked(uid){
  hideLoading();
  lineUserId = uid;
  document.getElementById('blocked-uid').textContent = 'LineUserID: ' + uid;
  document.getElementById('blocked-screen').style.display = 'flex';
}
function showMainApp(data){
  hideLoading();
  document.getElementById('main-app').style.display = 'block';
  document.getElementById('btn-submit-main').style.display = 'block';
  document.getElementById('user-name-display').textContent = data.name + (data.role ? ' ¬∑ ' + data.role : '');
  document.getElementById('headName').value = data.name;
  populateSites(data.sites || []);
  addEmpRow();
}
function copyUid(){
  if (!lineUserId) return;
  navigator.clipboard.writeText(lineUserId)
    .then(() => alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'))
    .catch(() => alert('LineUserID: ' + lineUserId));
}

// ‚îÄ‚îÄ callBackend ‚îÄ‚îÄ
async function callBackend(action, params) {
  const qs  = new URLSearchParams({ liffApi: '1', action, ...(params || {}) });
  const res  = await fetch(WEBAPP_URL + '?' + qs.toString(), { redirect: 'follow' });
  const text = await res.text();
  try { return JSON.parse(text); }
  catch(e) { throw new Error('Server error: ' + text.slice(0, 300)); }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.addEventListener('load', async function() {
  try {
    setMsg('‡∏Å‡∏≥‡∏•‡∏±‡∏á init LIFF...', '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 1/2');
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    setMsg('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...', '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 2/2');
    const profile = await liff.getProfile();
    lineUserId = profile.userId;

    const data = await callBackend('checkAndGetSites', { lineUserId });

    if (!data || !data.registered) {
      showBlocked(lineUserId);
      return;
    }

    currentUser = data;
    showMainApp(data);

  } catch(err) {
    showError('<b>Error:</b> ' + err.message);
  }
});

// ‚îÄ‚îÄ Sites ‚îÄ‚îÄ
function populateSites(sites){
  const sel = document.getElementById('siteSelect');
  sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>';
  if (!sites.length) {
    document.getElementById('site-empty-hint').style.display = 'block';
    return;
  }
  sites.forEach(s => {
    const o = document.createElement('option');
    o.value = s.id; o.textContent = s.name;
    sel.appendChild(o);
  });
  if (sites.length === 1) {
    sel.value = sites[0].id;
    handleSiteChange(); // ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  }
}

// ‚îÄ‚îÄ Tab ‚îÄ‚îÄ
function switchTab(tab){
  document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el  => el.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  document.getElementById('btn-tab-' + tab).classList.add('active');
  document.getElementById('btn-submit-main').style.display = tab === 'send' ? 'block' : 'none';
}
// ‚îÄ‚îÄ Emp rows ‚îÄ‚îÄ
function addEmpRow(){
  empRowCount++;
  const rid = 'emp_' + Date.now();
  const div = document.createElement('div');
  div.className = 'emp-card'; div.id = rid;
  div.innerHTML = `
    <div class="emp-head">
      <span><i class="fas fa-user me-1" style="color:#3b82f6"></i> ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${empRowCount}</span>
      <button class="btn-remove-emp" onclick="document.getElementById('${rid}').remove();updateSummary()">
        <i class="fas fa-times"></i> ‡∏•‡∏ö
      </button>
    </div>
    <div class="emp-body"><div class="row g-2">
      <div class="col-5">
        <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <input type="number" class="form-control emp-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1001" onchange="findEmpName(this)">
      </div>
      <div class="col-7">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" class="form-control emp-name" readonly placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥">
      </div>
      <div class="col-6">
        <label class="form-label">‡∏ú‡∏•‡∏±‡∏î</label>
        <select class="form-select emp-shift">
          <option value="D">‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô (D)</option>
          <option value="N">‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô (N)</option>
        </select>
      </div>
      <div class="col-6">
        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
        <input type="number" class="form-control text-end emp-amount" placeholder="0" oninput="updateSummary()">
      </div>
      
      <div class="col-12 mt-1">
        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label>
        <select class="form-select emp-type" style="font-size:.85rem;">
          <option value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤" selected>‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</option>
          <option value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà">‡πÄ‡∏ö‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà</option>
          <option value="‡∏£‡∏±‡∏ö‡∏™‡∏î‡∏Ñ‡∏ß‡∏á‡πÄ‡∏ß‡∏£">‡∏£‡∏±‡∏ö‡∏™‡∏î‡∏Ñ‡∏ß‡∏á‡πÄ‡∏ß‡∏£</option>
          <option value="‡∏£‡∏±‡∏ö‡∏™‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô">‡∏£‡∏±‡∏ö‡∏™‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
        </select>
      </div>

    </div></div>`;
  document.getElementById('empList').appendChild(div);
  updateSummary();
}
async function findEmpName(input){
  const id = input.value;
  const nameEl = input.closest('.emp-card').querySelector('.emp-name');
  if (String(id).length < 3) { nameEl.value = ''; return; }
  nameEl.value = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
  try {
    const r = await callBackend('findEmployee', { empId: id });
    nameEl.value = r.found ? r.name : '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ';
  } catch(e) { nameEl.value = '‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'; }
}

// ‚îÄ‚îÄ Site Employees Functions ‚îÄ‚îÄ
function handleSiteChange() {
  const siteId = document.getElementById('siteSelect').value;
  const card = document.getElementById('site-emp-card');
  const listContainer = document.getElementById('site-emp-list-container');
  const arrow = document.getElementById('site-emp-arrow');

  if (!siteId) {
    if (card) card.style.display = 'none';
    return;
  }
  
  // ‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏™‡∏°‡∏≠
  card.style.display = 'block';
  listContainer.style.display = 'none';
  arrow.className = 'fas fa-chevron-down ms-auto';
  
  // ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
  loadSiteEmployees(siteId);
}

async function loadSiteEmployees(siteId) {
  const listEl = document.getElementById('site-emp-list');
  listEl.innerHTML = '<div class="text-center py-3 text-muted"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
  
  try {
    const emps = await callBackend('getEmployeesBySite', { siteId: siteId });
    
    if (!emps || emps.length === 0) {
      listEl.innerHTML = '<div class="text-center py-3 text-muted" style="font-size:0.85rem;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</div>';
      return;
    }
    
    let html = '';
    emps.forEach(emp => {
      html += `
        <div class="site-emp-item">
          <div>
            <div style="font-weight:700; color:var(--navy);">${emp.name}</div>
            <div style="color:#6b7280; font-size:0.75rem;"><i class="fas fa-id-badge me-1"></i> ‡∏£‡∏´‡∏±‡∏™: ${emp.id}</div>
          </div>
          <button class="btn-quick-add" type="button" onclick="quickAddEmp('${emp.id}', '${emp.name}')">
            <i class="fas fa-plus me-1"></i> ‡πÄ‡∏ö‡∏¥‡∏Å
          </button>
        </div>
      `;
    });
    listEl.innerHTML = html;
  } catch (err) {
    listEl.innerHTML = '<div class="text-center py-3 text-danger" style="font-size:0.85rem;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    console.error("Load Emp Error:", err);
  }
}
  
function toggleSiteEmpList() {
  const container = document.getElementById('site-emp-list-container');
  const arrow = document.getElementById('site-emp-arrow');
  
  if (!container || !arrow) return;

  // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£
  if (container.style.display === 'none' || container.style.display === '') {
    container.style.display = 'block';
    arrow.className = 'fas fa-chevron-up ms-auto';
  } else {
    container.style.display = 'none';
    arrow.className = 'fas fa-chevron-down ms-auto';
  }
}
  
function quickAddEmp(id, name) {
  // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡πÄ‡∏ö‡∏¥‡πâ‡∏•)
  const existingInputs = document.querySelectorAll('.emp-id');
  for (let input of existingInputs) {
    if (input.value === id) {
      Swal.fire({
        title: '‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!',
        text: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö',
        icon: 'warning',
        toast: true,
        position: 'top',
        showConfirmButton: false,
        timer: 2000
      });
      return;
    }
  }

  // 2. ‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™)
  let emptyRowFound = false;
  document.querySelectorAll('.emp-card').forEach(card => {
    const idInput = card.querySelector('.emp-id');
    const nameInput = card.querySelector('.emp-name');
    if (!emptyRowFound && !idInput.value && !nameInput.value) {
      idInput.value = id;
      nameInput.value = name;
      emptyRowFound = true;
    }
  });

  // 3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°
  if (!emptyRowFound) {
    addEmpRow();
    const cards = document.querySelectorAll('.emp-card');
    const lastCard = cards[cards.length - 1];
    lastCard.querySelector('.emp-id').value = id;
    lastCard.querySelector('.emp-name').value = name;
  }
  
  Swal.fire({
    title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß',
    icon: 'success',
    toast: true,
    position: 'top',
    showConfirmButton: false,
    timer: 1500
  });
}
  
function updateSummary(){
  let sum = 0;
  document.querySelectorAll('.emp-amount').forEach(el => { sum += parseFloat(el.value) || 0; });
  document.getElementById('count-emp').textContent = document.querySelectorAll('.emp-card').length;
  document.getElementById('sum-amount').textContent = sum.toLocaleString('th-TH', { minimumFractionDigits: 2 });
}

// ‚îÄ‚îÄ Submit ‚îÄ‚îÄ
async function submitRequests(){
  if (!currentUser || !lineUserId) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÉ‡∏´‡∏°‡πà'); return; }
  const siteEl   = document.getElementById('siteSelect');
  const siteId   = siteEl.value;
  const siteName = siteEl.options[siteEl.selectedIndex].text;
  if (!siteId) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô', 'warning'); return; }

  let rows = [], hasErr = false;
  document.querySelectorAll('.emp-card').forEach(card => {
    const id  = card.querySelector('.emp-id').value;
    const nm  = card.querySelector('.emp-name').value;
    const sh  = card.querySelector('.emp-shift').value;
    const amt = card.querySelector('.emp-amount').value;
    if (!id && !amt) return;
    if (!id || !amt || !nm || nm.includes('‚ö†Ô∏è') || nm === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...') {
      card.style.borderColor = '#ef4444'; hasErr = true; return;
    }
    card.style.borderColor = '';
    rows.push({ id, name: nm, amount: parseFloat(amt), shift: sh });
  });

  if (hasErr) {
    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏î‡∏á', 'error');
    setTimeout(() => document.querySelectorAll('.emp-card').forEach(c => c.style.borderColor = ''), 3000);
    return;
  }
  if (!rows.length) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô', 'warning'); return; }

  const cf = await Swal.fire({
    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á?',
    html: `<b>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</b> ${siteName}<br><b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</b> ${rows.length} ‡∏Ñ‡∏ô<br><b>‡∏£‡∏ß‡∏°:</b> ${rows.reduce((s,r)=>s+r.amount,0).toLocaleString()} ‡∏ö‡∏≤‡∏ó`,
    icon: 'question', showCancelButton: true,
    confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', confirmButtonColor: '#06C755'
  });
  if (!cf.isConfirmed) return;

  Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
  try {
    const r = await callBackend('saveLineRequests', {
      headName: currentUser.name,
      site:     siteId,
      userId:   lineUserId,
      rows:     JSON.stringify(rows)
    });
    if (r.success) {
      await Swal.fire({ icon: 'success', title: '‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: 'Admin ‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ', confirmButtonColor: '#06C755' });
      document.getElementById('siteSelect').value = '';
      document.getElementById('empList').innerHTML = '';
      empRowCount = 0; addEmpRow();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', r.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏', 'error');
  } catch(e) { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + e, 'error'); }
}

// ‚îÄ‚îÄ History ‚îÄ‚îÄ
async function loadMyRequests(){
  if (!lineUserId) return;
  document.getElementById('history-list').innerHTML =
    '<div class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
  try {
    const rows = await callBackend('getMyRequests', { lineUserId });
    if (!rows || !rows.length) {
      document.getElementById('history-list').innerHTML =
        '<div class="text-center py-5 text-muted"><i class="fas fa-inbox fa-2x mb-2 d-block" style="opacity:.3"></i>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
      return;
    }
    let html = '';
    rows.forEach(r => {
      const bc = r.status === 'Transferred' ? 'badge-transferred' : 'badge-pending';
      const st = r.status === 'Transferred' ? '‚úÖ ‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
      html += `
        <div class="section-card mb-2">
          <div class="card-head d-flex justify-content-between">
            <span style="font-size:.8rem;"><i class="fas fa-clock me-1"></i>${r.timestamp}</span>
            <span class="badge rounded-pill ${bc}" style="font-size:.75rem;padding:3px 9px;">${st}</span>
          </div>
          <div class="form-wrap">
            <div class="row g-1" style="font-size:.85rem; align-items: center;">
              <div class="col-6"><span class="text-muted">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</span> <b>${r.empName}</b></div>
              <div class="col-6"><span class="text-muted">‡∏£‡∏´‡∏±‡∏™:</span> ${r.empId}</div>
              <div class="col-6"><span class="text-muted">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</span> ${r.site}</div>
              <div class="col-3"><span class="text-muted">‡∏ú‡∏•‡∏±‡∏î:</span> ${r.shift || '-'}</div>
              <div class="col-3 text-end"><b class="text-success">${parseFloat(r.amount).toLocaleString()} ‡∏ø</b></div>
              
              <div class="col-12 mt-2">
                <div class="d-flex align-items-center">
                  <span class="text-muted me-2" style="white-space: nowrap;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å:</span>
                  <select class="form-select form-select-sm req-type-select" style="font-size:.85rem;">
                    <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                    <option value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà">‡πÄ‡∏ö‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà</option>
                    <option value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤">‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</option>
                    <option value="‡∏£‡∏±‡∏ö‡∏™‡∏î‡∏Ñ‡∏ß‡∏á‡πÄ‡∏ß‡∏£">‡∏£‡∏±‡∏ö‡∏™‡∏î‡∏Ñ‡∏ß‡∏á‡πÄ‡∏ß‡∏£</option>
                    <option value="‡∏£‡∏±‡∏ö‡∏™‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô">‡∏£‡∏±‡∏ö‡∏™‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                  </select>
                </div>
              </div>
              
            </div>
          </div>
        </div>`;
    });
    document.getElementById('history-list').innerHTML = html;
  } catch(e) {
    document.getElementById('history-list').innerHTML =
      '<div class="text-center text-danger p-4">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e + '</div>';
  }
}
</script>
</body>
</html>
